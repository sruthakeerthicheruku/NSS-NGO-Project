<!DOCTYPE html>
<html>

<head>
  <title>User Dashboard - Donations</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #f8f9fa;
    }

    .status-success {
      color: green;
      font-weight: bold;
    }

    .status-pending {
      color: orange;
    }

    .status-failed {
      color: red;
    }
  </style>
</head>

<body>
  <h1>Welcome to the NGO Campaign</h1>

  <div class="card">
    <h3>Make a Donation</h3>
    <input type="number" id="amount" placeholder="Enter Amount" min="1">
    <button onclick="donate()">Donate Now</button>
  </div>

  <div class="card">
    <h3>My Donation History</h3>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Amount</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) window.location.href = 'index.html'; // Redirect if not logged in

    async function donate() {
      const amount = document.getElementById('amount').value;
      if (!amount) return alert("Please enter an amount");

      try {

        const initRes = await fetch('/api/donation/initiate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': token },
          body: JSON.stringify({ amount })
        });
        const initData = await initRes.json();


        const paymentChoice = prompt("Select Payment Method:\n1. UPI (GPay/PhonePe)\n2. Debit/Credit Card\n3. Net Banking", "1");

        if (paymentChoice) {
          const isAuthorized = confirm(`Confirming transaction of ₹${amount}. Do you want to authorize this payment?`);

          const finalStatus = isAuthorized ? 'success' : 'failed';

          // 3. Update the database with the result
          await fetch('/api/donation/verify-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': token },
            body: JSON.stringify({
              donationId: initData.donationId,
              simulatedStatus: finalStatus
            })
          });

          alert(`Payment of ₹${amount} was ${finalStatus}!`);
        } else {
          alert("Payment cancelled by user. Record remains as PENDING.");
        }

        loadHistory(); // Refresh the table
      } catch (err) {
        console.error("Donation Error:", err);
        alert("Something went wrong with the payment simulation.");
      }
    }

    async function loadHistory() {
      const res = await fetch('/api/donation/my-history', {
        headers: { 'Authorization': token }
      });
      const history = await res.json();
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = history.map(d => `
                <tr>
                    <td>${new Date(d.createdAt).toLocaleDateString()}</td>
                    <td>₹${d.amount}</td>
                    <td class="status-${d.status}">${d.status.toUpperCase()}</td>
                </tr>
            `).join('');
    }

    loadHistory();
  </script>
</body>

</html>