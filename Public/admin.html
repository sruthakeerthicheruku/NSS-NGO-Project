<!DOCTYPE html>
<html>

<head>
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f0f2f5;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .table-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    th {
      background: #f8f9fa;
    }
  </style>
</head>

<body>
  <h1>Admin Control Panel</h1>

  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Registrations</h3>
      <h2 id="totalUsers">0</h2>
    </div>
    <div class="stat-card">
      <h3>Total Donations</h3>
      <h2 id="totalMoney">$0</h2>
    </div>
  </div>
  <div style="margin-bottom: 20px; text-align: right;">
    <button onclick="exportToCSV()"
      style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
      Export Registration Data (CSV)
    </button>
  </div>

  <div class="table-card">
    <h3>All Donation Records</h3>
    <table id="adminTable">
      <thead>
        <tr>
          <th>User</th>
          <th>Email</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>


    const token = localStorage.getItem('token');
    const userRole = localStorage.getItem('role');
    if (!token || userRole !== 'admin') {
      alert("Access Denied: Admins Only");
      window.location.href = 'index.html';
    }

    async function loadDashboard() {
      try {
        const statsRes = await fetch('/api/admin/dashboard-stats', {
          headers: { 'Authorization': token }
        });
        const stats = await statsRes.json();

        document.getElementById('totalUsers').innerText = stats.totalUsers;

        document.getElementById('totalMoney').innerText = `₹${stats.totalDonations}`;

        const donRes = await fetch('/api/donation/all', {
          headers: { 'Authorization': token }
        });
        const donations = await donRes.json();

        const tbody = document.querySelector('#adminTable tbody');
        tbody.innerHTML = donations.map(d => `
            <tr>
                <td>${d.user?.name || 'Deleted User'}</td>
                <td>${d.user?.email || 'N/A'}</td>
                <td>₹${d.amount}</td> <td style="color: ${d.status === 'success' ? 'green' : 'red'}">
                    ${d.status.toUpperCase()}
                </td>
                <td>${new Date(d.createdAt).toLocaleDateString()}</td>
            </tr>
        `).join('');
      } catch (err) {
        console.error("Dashboard error:", err);
      }
    }
    function exportToCSV() {
      const rows = document.querySelectorAll("table tr");
      let csvContent = "data:text/csv;charset=utf-8,";

      rows.forEach(row => {
        const rowData = Array.from(row.cells).map(cell => cell.innerText).join(",");
        csvContent += rowData + "\r\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "NGO_Donations_Report.csv");
      document.body.appendChild(link);
      link.click();
    }

    loadDashboard();
  </script>
</body>

</html>